@page "/report-page"

@using CW_ordermedicine.Data.Models
@using CW_ordermedicine.Data.Services
@inject ReportService reportService
@inject UserService userService
@inject LoginService loginService
@inject NavigationManager NavigationManager
@inject IJSRuntime js

<div class="container-fluid">
	<CW_ordermedicine.Pages.Report.Menu></CW_ordermedicine.Pages.Report.Menu>
	<CW_ordermedicine.Pages.Report.Progress></CW_ordermedicine.Pages.Report.Progress>
	<div>
		@if (ListReport == null)
		{
			<p>Loading </p>
		}
		else
		{
			<RadzenDataGrid FilterMode="FilterMode.Simple" 
						AllowFiltering="true" AllowPaging="true" AllowSorting="true" AllowColumnResize="true"
						PageSize="50" Data="@(ListReport.Where(o => o.ReportStatus == "Success"))" TItem="CW_ordermedicine.Data.Models.Report" ColumnWidth="150px"
						FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
						LogicalFilterOperator="LogicalFilterOperator.Or">

				<Columns >
					<RadzenDataGridColumn TItem="Report " Title="ดูรายละเอียดเพิ่มเติม" TextAlign="TextAlign.Center" >
						<Template  Context="data">
							<RadzenButton Click=@(args => OpenOrderBillPage(data.ReportID))
									  ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" Icon="pageview" Class="m-1" /> @*ปุ่มดูรายละเอียด*@
						</Template>
					</RadzenDataGridColumn>

					<RadzenDataGridColumn TItem="CW_ordermedicine.Data.Models.Report" Property="ReportID" Title="รหัสคำสั่งซื้อ" Filterable="true">
					</RadzenDataGridColumn>

					<RadzenDataGridColumn TItem="CW_ordermedicine.Data.Models.Report" Property="ReportUserName" Title="ชื่อผู้ทำรายการ"
									  Type="typeof(IEnumerable<string>)" TextAlign="TextAlign.Center"
									  FilterValue="@selectedUserName" FilterOperator="FilterOperator.Contains"
									  LogicalFilterOperator="LogicalFilterOperator.Or">

						<FilterTemplate>
							<RadzenDropDown @bind-Value=selectedUserName Style="width:100%;"
										Data="@(ListUsers)" TextProperty="Name" ValueProperty="Name"
										AllowFiltering="true" AllowClear="true" Multiple="true" />
						</FilterTemplate>

					</RadzenDataGridColumn>

					<RadzenDataGridColumn TItem="Report" Title="แผนก" Property="ReportDepartment"
									  Type="typeof(IEnumerable<string>)" TextAlign="TextAlign.Center"
									  FilterValue="@selectedDepartment" FilterOperator="FilterOperator.Contains"
									  LogicalFilterOperator="LogicalFilterOperator.Or">

						<FilterTemplate>
							<RadzenDropDown @bind-Value=@selectedDepartment Style="width:100%;"
										Change=@OnSelectedDepartmentChange Data="@(Departments)" AllowClear="true" Multiple="true" />
						</FilterTemplate>
					</RadzenDataGridColumn>

					<RadzenDataGridColumn TItem="CW_ordermedicine.Data.Models.Report" Property="ReportPriceSum" Title="ราคาสุทธิ">
						<Template Context="report">
							@String.Format(new System.Globalization.CultureInfo("th-TH"), "{0:C}", report.ReportPriceSum)
						</Template>
						<FooterTemplate>
							@*@{
						var FinancialStructureValuseEur = this.ListReport.Sum(i => i.ReportPriceSum);
						}
						<b>
						<span class="mathsign">&sum;</span> @String.Format("{0:THB #,##0.00}",FinancialStructureValuseEur)
						</b>*@

							@*@if (CreateToVar == "")//มันสร้างvarได้แค่ภายในIFเลยต้องIFว่างๆมา//วิธีสำหรับให้เห็นราคารวมของแต่ละร้านค้า
						{
						var Report = ListReport.FindAll(e => e.ReportUserID == UserLogin.UserID);
						@String.Format(new System.Globalization.CultureInfo("th-TH"), "{0:C}",
						Report.Sum(e=>e.ReportPriceSum)
						)
						}*@
							ราคารวม : <b>@String.Format(new System.Globalization.CultureInfo("th-TH"), "{0:C}", ListReport.Sum(o => o.ReportPriceSum))</b> บาท
						</FooterTemplate>
					</RadzenDataGridColumn>

					<RadzenDataGridColumn TItem="CW_ordermedicine.Data.Models.Report" Property="ReportPriceSum" Title="ราคาสุทธิ"></RadzenDataGridColumn>

					<RadzenDataGridColumn TItem="CW_ordermedicine.Data.Models.Report" Property="ReportDate" Title="วันเวลาทำรายการ" FormatString="{0:d}"></RadzenDataGridColumn>

				</Columns>

			</RadzenDataGrid>
		}
		<div class="position-sticky " style=" bottom:0px; text-align:end;  ">
			<button class="btn btn-primary shadow mt-1 mb-2 me-3" style="border-radius:50%; font-size:30px; border:none;" data-bs-toggle="modal" data-bs-target="#FromAddMember">
				<i @onclick="GoToReportViewer" class="fa-solid fa-print" style="font-size:30px;"></i>
			</button>
		</div>
	</div>
</div>



@code {
	private List<CW_ordermedicine.Data.Models.Report> ListReport = new List<CW_ordermedicine.Data.Models.Report>();
	private List<User> ListUsers = new List<User>();
	private User UserLogin = new();
	private string CreateToVar = "";
	protected override async Task OnInitializedAsync()
	{
		var Reports = await reportService.GetReportsAsync();
		foreach (var Report in Reports)
		{
			ListReport.Add(new Report().ToUi(Report));
		}
		var Users = await userService.GetUserAsync();
		foreach (var User in Users)
		{
			ListUsers.Add(new User().ToUi(User));
		}
		UserLogin = new User().ToUi(loginService.UserToLogin); //แปลงไปใช้ของ UserToUI
	}

	IEnumerable<string> selectedDepartment;
	List<string> Departments = new List<string> { "Software", "Account", "Maid" };
	void OnSelectedDepartmentChange(object value)
	{
		if (selectedDepartment != null && !selectedDepartment.Any())
		{
			selectedDepartment = null;
		}
	}

	IEnumerable<string> selectedUserName;
	IEnumerable<int> selectedReportID;

	private void OpenOrderBillPage(int SentOrderIDPage)
	{
		NavigationManager.NavigateTo($"/orderbill/{SentOrderIDPage}");
	}
}
@code {
	private void GoToReportViewer()
	{
		NavigationManager.NavigateTo($"/reportViewer/");
	}
}